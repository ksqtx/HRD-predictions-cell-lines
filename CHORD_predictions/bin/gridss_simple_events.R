# Categorize GRIDSS breakends as DEL, DUP, INV, or TRA
# Adapted from https://github.com/PapenfussLab/gridss/blob/master/example/simple-event-annotation.R

library(VariantAnnotation)
library(StructuralVariantAnnotation)
library(tidyverse)

args <- commandArgs(trailingOnly = TRUE)
in_file <- args[1]
out_file <- args[2]


#' Simple SV type classifier
simpleEventType <- function(gr) {
  pgr = partner(gr)
  return(ifelse(seqnames(gr) != seqnames(pgr), "TRA", # inter-chromosomosal
                ifelse(strand(gr) == strand(pgr), "INV",
                       ifelse(gr$insLen >= abs(gr$svLen) * 0.7, "INS", # TODO: improve classification of complex events
                              ifelse(xor(start(gr) < start(pgr), strand(gr) == "-"), "DEL",
                                     "DUP")))))
}

# read VCF
vcf <- readVcf(in_file, 'hg38')

info(header(vcf)) = unique(as(rbind(as.data.frame(info(header(vcf))), data.frame(
  row.names=c("SIMPLE_TYPE"),
  Number=c("1"),
  Type=c("String"),
  Description=c("Simple event type annotation based purely on breakend position and orientation."))), "DataFrame"))
gr <- StructuralVariantAnnotation::breakpointRanges(vcf, inferMissingBreakends = FALSE)
svtype <- simpleEventType(gr)
# info(vcf)$SIMPLE_TYPE <- NA_character_
# info(vcf[gr$sourceId])$SIMPLE_TYPE <- svtype
# info(vcf[gr$sourceId])$SVLEN <- gr$svLen
# writeVcf(vcf, "chr12.1527326.DEL1024.sv.annotated.vcf") # generated by example/gridss.sh

# TODO: perform event filtering here
# By default, GRIDSS is very sensitive but this comes at the cost of a high false discovery rate
# gr <- gr[gr$FILTER == "PASS" & partner(gr)$FILTER == "PASS"] # Remove low confidence calls

simplegr <- gr[simpleEventType(gr) %in% c("INS", "INV", "DEL", "DUP", "TRA")]
simplebed <- data.frame(
  chrom=seqnames(simplegr),
  partner_chrom=seqnames(partner(simplegr)),
  # call the centre of the homology/inexact interval
  start=as.integer((start(simplegr) + end(simplegr)) / 2),
  end=as.integer((start(partner(simplegr)) + end(partner(simplegr))) / 2),
  name=simpleEventType(simplegr),
  score=simplegr$QUAL,
  strand="."
)

main_contigs <- paste0('chr', c(1:22, 'X', 'Y'))

simplebed <- simplebed %>%
  dplyr::filter(chrom %in% main_contigs, partner_chrom %in% main_contigs, name != 'INS') %>%
  dplyr::mutate(sv_len = end - start)

# Just the lower of the two breakends so we don't output everything twice
simplebed <- simplebed[simplebed$start < simplebed$end,]

simplebed <- simplebed %>%
  dplyr::transmute(sv_type = name, sv_len)

write.table(simplebed, out_file, 
            quote = FALSE, sep = '\t', row.names = FALSE, col.names = TRUE)
